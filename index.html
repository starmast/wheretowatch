<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Where To Watch NFL — Live & Next Games</title>
  <meta name="description" content="See NFL games for this week (live & upcoming) with your local kickoff times and where to watch (TV & streaming)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Force readable option popup colors for native selects */
    #weekSelect option, #weekSelect optgroup {
      color: #0f172a; /* slate-900 text on white */
      background: #ffffff;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">
  <div id="app" class="min-h-dvh flex flex-col">
    <header class="px-4 sm:px-6 lg:px-10 py-5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 font-bold">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-sky-500 to-violet-500 shadow-lg shadow-sky-500/30" aria-hidden="true"></div>
        <div>
          <div class="text-base tracking-tight">Where To Watch NFL</div>
          <div class="text-slate-400 text-sm">{{ tzText }}</div>
        </div>
      </div>
      <div class="text-slate-400 text-sm">{{ contextText }}</div>
    </header>

    <main class="px-4 sm:px-6 lg:px-10 pb-10 grow">
      <div class="flex flex-wrap items-center gap-3 mb-2">
        <h2 class="m-0 text-xl font-semibold">{{ sectionTitle }}</h2>
        <div class="text-slate-400 text-sm">{{ sectionSub }}</div>
        <div v-if="availableFutureWeeks.length" class="ml-auto flex items-center gap-2">
          <label for="weekSelect" class="text-slate-400 text-sm">Jump to:</label>
          <select id="weekSelect" :value="selectedWeek ?? ''" @change="onWeekChange" class="h-8 rounded-md bg-white/5 border border-white/10 text-sm px-2 text-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
            <option value="" disabled selected>Select week…</option>
            <option v-for="w in availableFutureWeeks" :key="w" :value="w">Week {{ w }}</option>
          </select>
        </div>
      </div>

      <div v-if="error" class="text-slate-400 text-sm border border-white/10 rounded-xl p-5">There was a problem loading the schedule. Please refresh to try again.</div>
      <div v-else-if="loading" class="text-slate-400 text-sm border border-white/10 rounded-xl p-5">Loading schedule…</div>

      <template v-else>
        <div v-if="displayGroups.length === 0" class="text-slate-400 text-sm border border-white/10 rounded-xl p-5">No games found.</div>
        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template v-for="group in displayGroups" :key="group.key">
            <div class="col-span-full flex items-center gap-2 text-slate-400 font-semibold mt-2">
              <span class="w-1.5 h-1.5 rounded-full bg-sky-500 shadow-[0_0_10px] shadow-sky-500/70"></span>
              <span>{{ group.label }}</span>
            </div>

            <div v-for="g in group.games" :key="g.gameId || (g.homeTeam.abbreviation + g.awayTeam.abbreviation + g.kickoffUtc)" class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-sm shadow-xl shadow-black/30 p-4 flex flex-col gap-3">
              <div class="grid [grid-template-columns:1fr_auto_1fr] items-center gap-2">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="w-10 h-10 rounded-full bg-white/10 ring-1 ring-white/10 overflow-hidden flex items-center justify-center" :title="g.awayTeam.fullName">
                    <img :src="teamLogoUrl(g.awayTeam.abbreviation)" :alt="g.awayTeam.abbreviation + ' logo'" class="w-full h-full object-contain p-1.5" @error="onLogoError($event)" />
                    <span class="hidden text-xs font-extrabold tracking-wide">{{ g.awayTeam.abbreviation }}</span>
                  </div>
                  <div class="truncate">{{ g.awayTeam.fullName }}</div>
                </div>
                <div class="text-slate-400 font-bold text-center px-2">@</div>
                <div class="flex items-center gap-2 min-w-0 justify-end">
                  <div class="truncate text-right">{{ g.homeTeam.fullName }}</div>
                  <div class="w-10 h-10 rounded-full bg-white/10 ring-1 ring-white/10 overflow-hidden flex items-center justify-center" :title="g.homeTeam.fullName">
                    <img :src="teamLogoUrl(g.homeTeam.abbreviation)" :alt="g.homeTeam.abbreviation + ' logo'" class="w-full h-full object-contain p-1.5" @error="onLogoError($event)" />
                    <span class="hidden text-xs font-extrabold tracking-wide">{{ g.homeTeam.abbreviation }}</span>
                  </div>
                </div>
              </div>

              <div class="text-slate-400 text-sm">{{ fmtTimeOnly(kickoffDate(g)) }}</div>

              <div class="flex items-center gap-2 flex-wrap">
                <template v-if="pickProviders(g).length === 0">
                  <span class="text-slate-400 text-sm">Providers to be announced</span>
                </template>
                <template v-else>
                  <a v-for="p in pickProviders(g)" :key="(p.code || p.name || p.domain) + (p.domain||'')" :href="p.url && p.url.startsWith('http') ? p.url : ('https://' + p.domain)" target="_blank" rel="noopener noreferrer" :title="p.name || p.domain" :aria-label="p.name || p.domain" class="inline-flex items-center gap-2 h-7 px-3 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 transition">
                    <img :src="faviconUrl(p.domain)" alt="" aria-hidden="true" class="w-4 h-4 object-contain" />
                    <span class="text-xs leading-none">{{ p.name || p.domain }}</span>
                  </a>
                </template>
              </div>
            </div>
          </template>
        </div>
      </template>
    </main>

    <footer class="px-4 sm:px-6 lg:px-10 py-6 text-slate-400 text-sm">
      Data times are provided in UTC and shown in your local timezone. Provider links go to official sites or apps. This site is unofficial and for convenience only.
    </footer>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, computed, onMounted, ref } = Vue;
    createApp({
      setup(){
        const loading = ref(true);
        const error = ref(false);
        const schedule = ref([]);
        const now = ref(new Date());
        const LIVE_WINDOW_HOURS = 4;
        const tz = ref(Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local Time');
        const selectedWeek = ref(null);

        function pickProviders(entry){
          const arr = Array.isArray(entry.providers) ? entry.providers.slice() : [];
          const order = { TV: 0, STREAMING: 1, RADIO: 2 };
          arr.sort((a,b)=> (order[a.kind] ?? 99) - (order[b.kind] ?? 99)
                         || (a.name || '').localeCompare(b.name || ''));
          for(const p of arr){
            if(!p.domain && p.url){
              try{ p.domain = new URL(p.url).hostname.replace(/^www\./,''); }catch{}
            }
          }
          return arr.filter(p => (p.url && p.url.startsWith('http')) || p.domain);
        }
        function fmtTimeOnly(dt){
          const opts = {hour:'numeric', minute:'2-digit', timeZoneName:'short'};
          return new Intl.DateTimeFormat(undefined, opts).format(dt);
        }
        function kickoffDate(g){
          return new Date(g.kickoffUtc);
        }
        function isLiveEntry(g){
          if (g.status === 'LIVE') return true;
          if (g.status === 'FINAL') return false;
          const start = kickoffDate(g);
          const durationMin = Number(g.estimatedDurationMinutes) > 0
            ? Number(g.estimatedDurationMinutes)
            : LIVE_WINDOW_HOURS * 60;
          const end = new Date(start.getTime() + durationMin * 60 * 1000);
          const nowMs = now.value.getTime();
          return nowMs >= start.getTime() && nowMs <= end.getTime();
        }
        function faviconUrl(domain){
          return `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(domain)}`;
        }
        function teamLogoUrl(abbr){
          if(!abbr) return '';
          return `https://static.www.nfl.com/t_q-best/league/api/clubs/logos/${encodeURIComponent(String(abbr).toUpperCase())}`;
        }
        function onLogoError(e){
          const img = e.target;
          const abbr = img.nextElementSibling;
          img.style.display = 'none';
          if(abbr) abbr.classList.remove('hidden');
        }

        function onWeekChange(event){
          const raw = event && event.target ? event.target.value : '';
          const val = raw === '' ? null : Number(raw);
          if(val === null || Number.isNaN(val)){
            selectedWeek.value = null;
            return;
          }
          // Week 18 should not appear in the dropdown since it's filtered out,
          // but if somehow selected, we should handle it gracefully
          if(val === 18){
            console.warn('Week 18 selected but should be filtered out of available weeks');
            const alt = availableFutureWeeks.value.find(w => w !== 18);
            if(alt != null){
              selectedWeek.value = alt;
            } else {
              // If no alternative week is available, reset to null rather than staying on Week 18
              selectedWeek.value = null;
            }
          } else {
            selectedWeek.value = val;
          }
        }

        const tzText = computed(()=> `Your time: ${tz.value}`);

        const currentWeek = computed(()=>{
          if(!schedule.value.length) return undefined;
          const sorted = schedule.value.slice().sort((a,b)=> kickoffDate(a) - kickoffDate(b));
          const nowMs = now.value.getTime();
          const pastOrNow = sorted.filter(g => kickoffDate(g).getTime() <= nowMs);
          if(pastOrNow.length > 0){
            return pastOrNow[pastOrNow.length - 1].week;
          }
          const firstFuture = sorted.find(g => kickoffDate(g).getTime() > nowMs);
          return firstFuture ? firstFuture.week : undefined;
        });

        // Season timeline helpers
        const earliestKickoff = computed(()=>{
          if(!schedule.value.length) return undefined;
          let min;
          for(const g of schedule.value){
            const t = kickoffDate(g).getTime();
            if(min == null || t < min) min = t;
          }
          return min;
        });
        const seasonHasStarted = computed(()=>{
          const ek = earliestKickoff.value;
          if(ek == null) return false;
          return now.value.getTime() >= ek;
        });
        const firstWeekNumber = computed(()=>{
          const weeks = Array.from(new Set(
            schedule.value
              .filter(g => g.week !== 18)
              .map(g => g.week)
          )).sort((a,b)=> a - b);
          return weeks[0];
        });

        const availableFutureWeeks = computed(()=>{
          const nowMs = now.value.getTime();
          const set = new Set(
            schedule.value
              .filter(g => g.week !== 18)
              .filter(g => kickoffDate(g).getTime() > nowMs)
              .map(g => g.week)
          );
          return Array.from(set).sort((a,b)=> a - b);
        });

        const nextWeekNumber = computed(()=> availableFutureWeeks.value[0]);

        const isShowingThisWeek = computed(()=>{
          // If the user has explicitly selected a week, we are not showing "this week"
          if(selectedWeek.value != null) return false;
          if(!schedule.value.length) return false;
          // Before the season starts, do not show "This week" — default to Week 1 view
          if(!seasonHasStarted.value) return false;
          const week = currentWeek.value;
          if(week === undefined) return false;
          const nowMs = now.value.getTime();
          const weekUpcoming = schedule.value.filter(g => g.week === week && (kickoffDate(g).getTime() >= nowMs || isLiveEntry(g)));
          return weekUpcoming.length > 0;
        });

        const filteredGames = computed(()=>{
          const s = schedule.value;
          if(!s.length) return [];
          const nowMs = now.value.getTime();
          const week = currentWeek.value;
          if(week === undefined) return [];

          // If we're still showing "This week", keep prior behavior
          if(isShowingThisWeek.value){
            return s.filter(g => g.week === week && (kickoffDate(g).getTime() >= nowMs || isLiveEntry(g)));
          }

          // Before the season starts and no user selection, default to Week 1 (first week in schedule)
          if(!seasonHasStarted.value && selectedWeek.value == null){
            const fw = firstWeekNumber.value;
            if(fw != null) return s.filter(g => g.week === fw);
          }

          // Otherwise, show the user-selected future week (default to next future week)
          let targetWeek = selectedWeek.value ?? nextWeekNumber.value;
          // Coerce away from Week 18 if user somehow has it selected or is the default
          if(targetWeek === 18){
            const alt = availableFutureWeeks.value.find(w => w !== 18);
            if(alt != null){
              targetWeek = alt;
            } else {
              return [];
            }
          }
          if(targetWeek == null) return [];
          return s.filter(g => g.week === targetWeek);
        });

        const sectionTitle = computed(()=>{
          const s = schedule.value;
          if(error.value) return 'Error loading schedule';
          if(loading.value) return 'Loading…';
          if(!s.length) return 'No upcoming NFL games';
          const week = currentWeek.value;
          if(week === undefined) return 'No upcoming NFL games';

          if(isShowingThisWeek.value){
            return `This week — Week ${week}`;
          }

          // Before season starts and no user selection, label simply as Week 1 (first week)
          if(!seasonHasStarted.value && selectedWeek.value == null){
            const fw = firstWeekNumber.value;
            if(fw != null) return `Week ${fw}`;
          }

          let target = selectedWeek.value ?? nextWeekNumber.value;
          if(target === 18){
            const alt = availableFutureWeeks.value.find(w => w !== 18);
            if(alt != null){
              target = alt;
            } else {
              return 'No upcoming NFL games';
            }
          }
          if(target == null) return 'No upcoming NFL games';
          if(selectedWeek.value == null || target === nextWeekNumber.value){
            return `Next week — Week ${target}`;
          }
          return `Week ${target}`;
        });
        const sectionSub = computed(()=>{
          if(loading.value || error.value) return '';
          const s = schedule.value;
          if(!s.length) return '';
          // Before season starts and no user selection, don't imply "this week"
          if(!seasonHasStarted.value && selectedWeek.value == null) return 'All times local to you';
          const nowMs = now.value.getTime();
          const week = currentWeek.value;
          if(week === undefined) return '';
          const weekUpcoming = s.filter(g => g.week === week && (kickoffDate(g).getTime() >= nowMs || isLiveEntry(g)));
          return weekUpcoming.length > 0 ? 'Remaining games this week (live and upcoming; all times local)' : 'All times local to you';
        });
        const contextText = computed(()=>{
          if(loading.value) return 'Loading schedule…';
          if(error.value) return 'Load error';
          const s = filteredGames.value;
          if(s.length === 0) return 'No games remain in the schedule.';

          if(isShowingThisWeek.value) return 'Showing remaining games this week';

          // Before the season starts and no user selection, prefer Week 1 wording
          if(!seasonHasStarted.value && selectedWeek.value == null){
            const fw = firstWeekNumber.value;
            if(fw != null) return `Showing Week ${fw}`;
          }

          let target = selectedWeek.value ?? nextWeekNumber.value;
          if(target === 18){
            const alt = availableFutureWeeks.value.find(w => w !== 18);
            if(alt != null){
              target = alt;
            } else {
              return 'No upcoming NFL games';
            }
          }
          if(target == null) return 'No upcoming NFL games';
          if(selectedWeek.value == null || target === nextWeekNumber.value){
            return 'Showing the next week of games';
          }
          return `Showing Week ${target}`;
        });

        const displayGroups = computed(()=>{
          const games = filteredGames.value.slice().sort((a,b)=> kickoffDate(a) - kickoffDate(b));
          if(games.length === 0) return [];
          const map = new Map();
          for(const g of games){
            const d = kickoffDate(g);
            const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
            if(!map.has(key)) map.set(key, { key, date: d, games: [] });
            map.get(key).games.push(g);
          }
          const ordered = Array.from(map.values()).sort((a,b)=> a.date - b.date);
          for(const grp of ordered){
            grp.games.sort((a,b)=> kickoffDate(a) - kickoffDate(b));
            grp.label = new Intl.DateTimeFormat(undefined, {weekday:'long', month:'long', day:'numeric'}).format(grp.date);
          }
          return ordered;
        });

        onMounted(async ()=>{
          try{
            const res = await fetch('schedule.json', {cache:'no-store'});
            if(!res.ok) throw new Error('Failed to load schedule.json');
            const json = await res.json();
            if(!Array.isArray(json)) throw new Error('Unexpected schedule format');
            json.sort((a,b)=> new Date(a.kickoffUtc) - new Date(b.kickoffUtc));
            schedule.value = json;
          }catch(e){
            console.error(e);
            error.value = true;
          } finally {
            loading.value = false;
          }
        });

        return {
          // state
          loading, error,
          // dropdown state
          selectedWeek,
          // computed text & flags
          tzText, contextText, sectionTitle, sectionSub, displayGroups, isShowingThisWeek, availableFutureWeeks,
          // methods used in template
          pickProviders, faviconUrl, teamLogoUrl, fmtTimeOnly, onLogoError, onWeekChange,
          // helpers used in template
          kickoffDate,
        };
      }
    }).mount('#app');
  </script>
</body>
</html>